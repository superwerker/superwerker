version: 0.2
env:
  shell: bash

phases:
  build:
    commands:
      # setup AWS CLI to talk to vended account
      - aws configure --profile test_account set role_arn ${AWS_CROSS_ACCOUNT_ROLE_ARN}
      - aws configure --profile test_account set credential_source EcsContainer

      # close sub-accounts so that the OVM can close the main / management account later
      - cd $CODEBUILD_SRC_DIR/tests/close-active-subaccounts
      - npm i
      # Node + ECS Container Creds + Assume Role doesn't seem to work, so work around by setting credentials
      - eval $(aws sts assume-role --role-arn ${AWS_CROSS_ACCOUNT_ROLE_ARN} --role-session-name test | jq -r '.Credentials | "export js_aws_access_key_id=\(.AccessKeyId)\nexport js_aws_secret_access_key=\(.SecretAccessKey)\nexport js_aws_session_token=\(.SessionToken)\n"')
      - AWS_ACCESS_KEY_ID=$js_aws_access_key_id AWS_SECRET_ACCESS_KEY=$js_aws_secret_access_key AWS_SESSION_TOKEN=$js_aws_session_token AWS_REGION=${SUPERWERKER_REGION} CAPTCHA_KEY=$CAPTCHA_API_KEY node close-active-subaccounts.js

    finally:
      # empty buckets before trying to delete them
      - for bucket in $(aws s3 ls --profile test_account --region ${SUPERWERKER_REGION} | cut -d" " -f 3); do echo "Emptying bucket $bucket"; aws s3 rm --profile test_account --region ${SUPERWERKER_REGION} s3://$bucket --recursive; done
      # remove stacks
      - aws cloudformation delete-stack --stack-name superwerker-pipeline-dns-wiring-${AWS_ACCOUNT_ID}
      - aws --profile test_account --region ${SUPERWERKER_REGION} cloudformation delete-stack --stack-name superwerker
